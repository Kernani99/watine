<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العلاجات - عيادة واتين للأسنان</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #a76dac;
            --secondary: #8e44ad;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light-pink: #f8e1f4;
            --light-purple: #f3e5f5;
            --dark: #4a235a;
            --light: #f9f9f9;
            --gray: #95a5a6;
            --white: #ffffff;
            --teeth-color: #f5f5f5;
            --treated-teeth: #a76dac;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #fdf5fd;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .clinic-logo {
            height: 70px;
            width: auto;
        }
        
        .header-text {
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 700;
            color: white;
        }
        
        .header-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .card {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-pink);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0c8e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background-color: var(--light-pink);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(167, 109, 172, 0.2);
            background-color: white;
        }
        
        .patient-balance {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: #f0f0f0;
            font-size: 14px;
            text-align: center;
        }
        
        .balance-positive {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .balance-zero {
            color: #27ae60;
        }
        
        /* تعديلات Select2 */
        .select2-container {
            width: 100% !important;
        }
        
        .select2-container--default .select2-selection--single {
            border: 1px solid #e0c8e0 !important;
            border-radius: 10px !important;
            height: auto !important;
            padding: 10px !important;
            background-color: var(--light-pink) !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100% !important;
            left: 10px !important;
            right: auto !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding-right: 20px !important;
            padding-left: 10px !important;
            text-align: right !important;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn i {
            margin-left: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .btn-pink {
            background-color: #f8bbd0;
            color: #880e4f;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* تصميم مخطط الأسنان */
        .teeth-chart {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .teeth-title {
            text-align: center;
            margin-bottom: 15px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .teeth-row {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .tooth {
            width: 30px;
            height: 40px;
            margin: 0 5px;
            background-color: var(--teeth-color);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 1px solid #ddd;
        }
        
        .tooth:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tooth.treated {
            background-color: var(--treated-teeth);
            color: white;
        }
        
        .tooth-number {
            font-size: 12px;
            font-weight: bold;
        }
        
        .teeth-section {
            margin-bottom: 30px;
        }
        
        .teeth-section-title {
            text-align: center;
            margin: 15px 0;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* قسم الوصفات الطبية */
        .prescription-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed var(--light-pink);
        }
        
        .medication-item {
            background-color: var(--light-pink);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .add-medication {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        /* تصميم جديد لسجل العلاجات */
        .compact-treatment {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0e6ef;
        }
        
        .compact-treatment-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .compact-treatment-actions {
            display: flex;
            gap: 8px;
        }
        
        .view-treatment-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-treatment-btn:hover {
            background-color: var(--secondary);
            transform: scale(1.1);
        }
        
        /* نافذة التقرير */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0e6ef;
        }
        
        .modal-title {
            font-size: 22px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--danger);
        }
        
        /* تقرير العلاج */
        .report {
            background-color: white;
            padding: 30px;
            max-width: 700px;
            margin: 0 auto;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            border: 1px solid #f0e6ef;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px dashed #f0e6ef;
        }
        
        .clinic-name {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .doctor-info {
            font-size: 18px;
            margin: 10px 0;
            color: var(--dark);
        }
        
        .clinic-address {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 15px;
        }
        
        .report-logo {
            height: 80px;
            margin-bottom: 15px;
        }
        
        .report-title {
            font-size: 20px;
            color: var(--dark);
            margin: 15px 0;
        }
        
        .report-patient {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .report-details {
            margin: 25px 0;
        }
        
        .report-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .report-label {
            font-weight: 600;
            color: var(--gray);
        }
        
        .report-value {
            font-weight: 500;
        }
        
        .report-teeth {
            margin: 20px 0;
        }
        
        .report-teeth-title {
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .report-teeth-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .report-tooth {
            background-color: var(--light-pink);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .report-medications {
            margin-top: 20px;
        }
        
        .report-medication {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #f0e6ef;
            margin-bottom: 10px;
        }
        
        .report-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #f0e6ef;
            font-size: 14px;
            color: var(--gray);
        }
        
        /* تأثيرات خاصة */
        .floral-decoration {
            position: absolute;
            opacity: 0.1;
            z-index: 0;
        }
        
        .floral-1 {
            top: 20px;
            left: 20px;
            transform: rotate(30deg);
        }
        
        .floral-2 {
            bottom: 20px;
            right: 20px;
            transform: rotate(-20deg);
        }
        
        /* إعدادات الطباعة */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .report, .report * {
                visibility: visible;
            }
            
            .report {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 15px;
                box-shadow: none;
                border: none;
            }
            
            .no-print, .close-btn {
                display: none !important;
            }
            
            @page {
                size: A4;
                margin: 10mm;
            }
            
            .prescription-only {
                page: prescription;
            }
            
            @page prescription {
                size: A5;
                margin: 8mm;
            }
            
            .prescription-only .report-header,
            .prescription-only .report-details,
            .prescription-only .report-teeth,
            .prescription-only .report-footer {
                display: none;
            }
            
            .prescription-only .report-title {
                font-size: 18pt;
                text-align: center;
                margin: 10px 0;
            }
            
            .prescription-only .report-medications {
                margin-top: 10px;
            }
            
            .prescription-only .report-medication {
                display: block;
                padding: 5px 0;
                margin-bottom: 15px;
                border-bottom: none;
            }
            
            .prescription-only .report-medication span {
                display: block;
                margin-bottom: 5px;
            }
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .teeth-row {
                flex-wrap: wrap;
            }
            
            .tooth {
                margin: 5px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .clinic-logo {
                height: 60px;
            }
            
            .report-patient {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="https://i.ibb.co/ZzrbF0P4/SVG.png" alt="شعار العيادة" class="clinic-logo">
            <div class="header-text">
                <h1><i class="fas fa-teeth"></i> نظام إدارة العلاجات</h1>
                <div class="header-info">
                    <span><i class="fas fa-hospital"></i> عيادة وتين لطب الأسنان</span>
                    <span><i class="fas fa-map-marker-alt"></i> حي العزامية عين ازال</span>
                </div>
            </div>
        </div>
        <i class="fas fa-heart floral-decoration floral-1" style="color: var(--primary); font-size: 40px;"></i>
        <i class="fas fa-spa floral-decoration floral-2" style="color: var(--primary); font-size: 40px;"></i>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title"><i class="fas fa-teeth-open" style="color: var(--primary);"></i> تسجيل علاج جديد</h2>
            <form id="treatment-form">
                <input type="hidden" id="treatment-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="patient-select"><i class="fas fa-user-injured" style="margin-left: 5px;"></i> المريض</label>
                        <select id="patient-select" class="form-control" required style="width: 100%">
                            <option value="">اختر المريض...</option>
                        </select>
                        <div id="patient-balance" class="patient-balance" style="display: none;">
                            <span id="balance-text"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="treatment-type"><i class="fas fa-teeth" style="margin-left: 5px;"></i> نوع العلاج</label>
                        <select id="treatment-type" class="form-control" required>
                            <option value="">اختر نوع العلاج...</option>
                            <option value="حشوة">حشوة</option>
                            <option value="تنظيف">تنظيف</option>
                            <option value="قلع">قلع</option>
                            <option value="تقويم">تقويم</option>
                            <option value="تركيبة">تركيبة</option>
                            <option value="علاج عصب">علاج عصب</option>
                            <option value="تبييض">تبييض</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="treatment-date"><i class="far fa-calendar-alt" style="margin-left: 5px;"></i> تاريخ العلاج</label>
                        <input type="date" id="treatment-date" class="form-control" required>
                    </div>
                </div>
                
                <!-- مخطط الأسنان -->
                <div class="teeth-chart">
                    <h3 class="teeth-title"><i class="fas fa-tooth" style="margin-left: 5px;"></i> تحديد الأسنان المعالجة</h3>
                    
                    <div class="teeth-section">
                        <h4 class="teeth-section-title">الفك العلوي</h4>
                        <div class="teeth-row">
                            <div class="tooth" data-number="18"><span class="tooth-number">18</span></div>
                            <div class="tooth" data-number="17"><span class="tooth-number">17</span></div>
                            <div class="tooth" data-number="16"><span class="tooth-number">16</span></div>
                            <div class="tooth" data-number="15"><span class="tooth-number">15</span></div>
                            <div class="tooth" data-number="14"><span class="tooth-number">14</span></div>
                            <div class="tooth" data-number="13"><span class="tooth-number">13</span></div>
                            <div class="tooth" data-number="12"><span class="tooth-number">12</span></div>
                            <div class="tooth" data-number="11"><span class="tooth-number">11</span></div>
                        </div>
                        <div class="teeth-row">
                            <div class="tooth" data-number="21"><span class="tooth-number">21</span></div>
                            <div class="tooth" data-number="22"><span class="tooth-number">22</span></div>
                            <div class="tooth" data-number="23"><span class="tooth-number">23</span></div>
                            <div class="tooth" data-number="24"><span class="tooth-number">24</span></div>
                            <div class="tooth" data-number="25"><span class="tooth-number">25</span></div>
                            <div class="tooth" data-number="26"><span class="tooth-number">26</span></div>
                            <div class="tooth" data-number="27"><span class="tooth-number">27</span></div>
                            <div class="tooth" data-number="28"><span class="tooth-number">28</span></div>
                        </div>
                    </div>
                    
                    <div class="teeth-section">
                        <h4 class="teeth-section-title">الفك السفلي</h4>
                        <div class="teeth-row">
                            <div class="tooth" data-number="48"><span class="tooth-number">48</span></div>
                            <div class="tooth" data-number="47"><span class="tooth-number">47</span></div>
                            <div class="tooth" data-number="46"><span class="tooth-number">46</span></div>
                            <div class="tooth" data-number="45"><span class="tooth-number">45</span></div>
                            <div class="tooth" data-number="44"><span class="tooth-number">44</span></div>
                            <div class="tooth" data-number="43"><span class="tooth-number">43</span></div>
                            <div class="tooth" data-number="42"><span class="tooth-number">42</span></div>
                            <div class="tooth" data-number="41"><span class="tooth-number">41</span></div>
                        </div>
                        <div class="teeth-row">
                            <div class="tooth" data-number="31"><span class="tooth-number">31</span></div>
                            <div class="tooth" data-number="32"><span class="tooth-number">32</span></div>
                            <div class="tooth" data-number="33"><span class="tooth-number">33</span></div>
                            <div class="tooth" data-number="34"><span class="tooth-number">34</span></div>
                            <div class="tooth" data-number="35"><span class="tooth-number">35</span></div>
                            <div class="tooth" data-number="36"><span class="tooth-number">36</span></div>
                            <div class="tooth" data-number="37"><span class="tooth-number">37</span></div>
                            <div class="tooth" data-number="38"><span class="tooth-number">38</span></div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="treated-teeth" name="treated-teeth">
                </div>
                
                <div class="form-group">
                    <label for="treatment-notes"><i class="far fa-sticky-note" style="margin-left: 5px;"></i> ملاحظات العلاج</label>
                    <textarea id="treatment-notes" class="form-control" rows="3" placeholder="أي ملاحظات إضافية عن العلاج..."></textarea>
                </div>
                
                <!-- قسم الوصفات الطبية -->
                <div class="prescription-section">
                    <h3 class="card-title"><i class="fas fa-prescription-bottle-alt" style="color: var(--primary);"></i> الوصفة الطبية</h3>
                    
                    <div id="medications-container">
                        <!-- سيتم إضافة الأدوية هنا -->
                    </div>
                    
                    <div class="add-medication">
                        <button type="button" id="add-medication" class="btn btn-pink">
                            <i class="fas fa-plus-circle"></i> إضافة دواء
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" id="save-treatment" class="btn btn-primary">
                        <i class="fas fa-save"></i> حفظ العلاج
                    </button>
                    <button type="button" id="update-treatment" class="btn btn-warning" style="display: none;">
                        <i class="fas fa-sync-alt"></i> تحديث العلاج
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> إعادة تعيين
                    </button>
                    <button type="button" id="cancel-edit" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
            </form>
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-history" style="color: var(--primary);"></i> سجل العلاجات</h2>
            
            <div style="margin-bottom: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <input type="text" id="search-treatments" class="form-control" placeholder="ابحث باسم المريض أو نوع العلاج...">
                    </div>
                    <div class="form-group">
                        <input type="date" id="filter-date" class="form-control">
                    </div>
                </div>
            </div>
            
            <div id="treatments-list">
                <p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> جاري تحميل سجل العلاجات...</p>
            </div>
        </div>
    </div>
    
    <!-- نافذة تقرير العلاج -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 class="modal-title"><i class="fas fa-file-medical-alt" style="color: var(--primary);"></i> تقرير العلاج</h3>
                <button class="close-btn" onclick="closeReportModal()">&times;</button>
            </div>
            <div id="report-content" class="report">
                <!-- سيتم تعبئته بواسطة JavaScript -->
            </div>
            <div class="action-buttons no-print" style="justify-content: center; margin-top: 20px;">
                <button onclick="printReport()" class="btn btn-primary">
                    <i class="fas fa-print"></i> طباعة التقرير الكامل
                </button>
                <button onclick="printPrescriptionOnly()" class="btn btn-success">
                    <i class="fas fa-prescription-bottle-alt"></i> طباعة الوصفة فقط
                </button>
                <button onclick="closeReportModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- مكتبات JavaScript -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            databaseURL: "https://watine-b8878-default-rtdb.firebaseio.com/"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // متغيرات التطبيق
        let patients = [];
        let treatments = [];
        let isEditing = false;
        let currentTreatmentId = null;
        let treatedTeeth = [];
        let medications = [];
        let currentPatientBalance = 0;
        
        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين تاريخ اليوم كقيمة افتراضية
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('treatment-date').value = today;
            
            // تهيئة Select2 لبحث المرضى
            $('#patient-select').select2({
                placeholder: "ابحث عن مريض...",
                allowClear: true,
                width: '100%',
                language: {
                    noResults: function() {
                        return "لا توجد نتائج";
                    },
                    searching: function() {
                        return "جاري البحث...";
                    }
                }
            });
            
            // تحميل قائمة المرضى
            loadPatients();
            
            // تحميل سجل العلاجات
            loadTreatments();
            
            // إدارة الأسنان المعالجة
            setupTeethSelection();
            
            // إدارة الوصفات الطبية
            setupMedications();
            
            // حفظ العلاج
            document.getElementById('save-treatment').addEventListener('click', saveTreatment);
            
            // تحديث العلاج
            document.getElementById('update-treatment').addEventListener('click', updateTreatment);
            
            // إلغاء التعديل
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // البحث والتصفية
            document.getElementById('search-treatments').addEventListener('input', filterTreatments);
            document.getElementById('filter-date').addEventListener('change', filterTreatments);
            
            // عند تغيير اختيار المريض
            document.getElementById('patient-select').addEventListener('change', function() {
                const patientId = this.value;
                if (patientId) {
                    loadPatientBalance(patientId);
                } else {
                    document.getElementById('patient-balance').style.display = 'none';
                }
            });
        });
        
        // تحميل رصيد المريض
        function loadPatientBalance(patientId) {
            database.ref('/Watine/patients/' + patientId + '/balance').once('value')
                .then(snapshot => {
                    const balance = snapshot.val() || 0;
                    currentPatientBalance = balance;
                    
                    const balanceElement = document.getElementById('patient-balance');
                    const balanceText = document.getElementById('balance-text');
                    
                    balanceElement.style.display = 'block';
                    
                    if (balance > 0) {
                        balanceText.textContent = `المبلغ المستحق: ${balance} دج`;
                        balanceText.className = 'balance-positive';
                    } else if (balance < 0) {
                        balanceText.textContent = `لدينا رصيد للمريض: ${Math.abs(balance)} دج`;
                        balanceText.className = 'balance-zero';
                    } else {
                        balanceText.textContent = 'لا يوجد رصيد مستحق';
                        balanceText.className = 'balance-zero';
                    }
                })
                .catch(error => {
                    console.error("Error loading patient balance:", error);
                });
        }
        
        // تحميل قائمة المرضى
        function loadPatients() {
            $('#patient-select').html('<option value=""><i class="fas fa-spinner fa-spin"></i> جاري تحميل المرضى...</option>');
            
            database.ref('/Watine/patients').once('value')
                .then(snapshot => {
                    patients = [];
                    $('#patient-select').empty().append('<option value="">اختر المريض...</option>');
                    
                    const patientsData = snapshot.val();
                    if (patientsData) {
                        Object.entries(patientsData).forEach(([id, patient]) => {
                            if (patient && patient.fullName) {
                                const phone = patient.phone || 'بدون رقم';
                                const option = new Option(`${patient.fullName} - ${phone}`, id);
                                $('#patient-select').append(option);
                                patients.push({ 
                                    id, 
                                    name: patient.fullName, 
                                    phone: phone,
                                    balance: patient.balance || 0
                                });
                            }
                        });
                        
                        if (patients.length === 0) {
                            $('#patient-select').html('<option value="">لا يوجد مرضى مسجلين بعد</option>');
                        }
                    } else {
                        $('#patient-select').html('<option value="">لا يوجد مرضى مسجلين بعد</option>');
                    }
                    $('#patient-select').trigger('change');
                })
                .catch(error => {
                    console.error("Error loading patients:", error);
                    $('#patient-select').html('<option value="">حدث خطأ في تحميل المرضى</option>');
                });
        }
        
        // تحميل سجل العلاجات
        function loadTreatments() {
            const treatmentsList = document.getElementById('treatments-list');
            treatmentsList.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> جاري تحميل سجل العلاجات...</p>';
            
            database.ref('/Watine/treatments').orderByChild('date').once('value')
                .then(snapshot => {
                    treatments = [];
                    treatmentsList.innerHTML = '';
                    
                    const treatmentsData = snapshot.val();
                    if (treatmentsData) {
                        Object.entries(treatmentsData).forEach(([id, treatment]) => {
                            if (treatment.patientId && treatment.type) {
                                treatments.push({ id, ...treatment });
                            }
                        });
                        
                        // عرض العلاجات بعد الفرز من الأحدث إلى الأقدم
                        displayTreatments(treatments.reverse());
                    } else {
                        treatmentsList.innerHTML = '<p style="text-align: center;">لا توجد علاجات مسجلة بعد</p>';
                    }
                })
                .catch(error => {
                    console.error("Error loading treatments:", error);
                    treatmentsList.innerHTML = '<p style="text-align: center;" class="error">حدث خطأ في تحميل العلاجات</p>';
                });
        }
        
        // عرض العلاجات في القائمة (تصميم مضغوط)
        function displayTreatments(treatmentsToDisplay) {
            const treatmentsList = document.getElementById('treatments-list');
            
            if (treatmentsToDisplay.length === 0) {
                treatmentsList.innerHTML = '<p style="text-align: center;">لا توجد علاجات تطابق معايير البحث</p>';
                return;
            }
            
            treatmentsList.innerHTML = '';
            
            treatmentsToDisplay.forEach(treatment => {
                const patient = patients.find(p => p.id === treatment.patientId);
                if (!patient) return; // تخطي العلاجات التي لا يوجد لها مريض
                
                const treatmentDate = treatment.date ? formatDateWithForeignNumbers(new Date(treatment.date)) : 'غير محدد';
                
                const treatmentElement = document.createElement('div');
                treatmentElement.className = 'compact-treatment';
                treatmentElement.innerHTML = `
                    <div class="compact-treatment-info">
                        <div class="patient-avatar">${patient.name.charAt(0)}</div>
                        <div>
                            <h4 style="margin: 0;">${patient.name}</h4>
                            <small>${treatment.type} - ${treatmentDate}</small>
                        </div>
                    </div>
                    <div class="compact-treatment-actions">
                        <button class="view-treatment-btn" onclick="viewTreatmentDetails('${treatment.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editTreatment('${treatment.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTreatment('${treatment.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                treatmentsList.appendChild(treatmentElement);
            });
        }
        
        // عرض تفاصيل العلاج
        function viewTreatmentDetails(treatmentId) {
            const treatment = treatments.find(t => t.id === treatmentId);
            if (!treatment) return;
            
            const patient = patients.find(p => p.id === treatment.patientId) || {
                name: 'مريض غير معروف',
                phone: 'غير متوفر'
            };
            
            const treatmentDate = treatment.date ? formatDateWithForeignNumbers(new Date(treatment.date)) : 'غير محدد';
            const treatedTeethList = treatment.treatedTeeth ? treatment.treatedTeeth.split(',') : [];
            
            const detailsHtml = `
                <div class="treatment-details">
                    <div class="treatment-patient">
                        <div class="patient-avatar">${patient.name.charAt(0)}</div>
                        <div>
                            <h3>${patient.name}</h3>
                            <p>${patient.phone}</p>
                        </div>
                    </div>
                    
                    <div class="treatment-type">
                        <i class="fas fa-teeth"></i> نوع العلاج: ${treatment.type}
                    </div>
                    
                    <div class="treatment-date">
                        <i class="far fa-calendar-alt"></i> تاريخ العلاج: ${treatmentDate}
                    </div>
                    
                    ${treatedTeethList.length > 0 ? `
                        <div>
                            <strong>الأسنان المعالجة:</strong>
                            <div class="treated-teeth-list">
                                ${treatedTeethList.map(tooth => `
                                    <span class="treated-tooth">${tooth}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${treatment.notes ? `
                        <div class="treatment-notes">
                            <strong>ملاحظات:</strong> ${treatment.notes}
                        </div>
                    ` : ''}
                    
                    ${treatment.medications && treatment.medications.length > 0 ? `
                        <div class="medication-list">
                            <strong>الوصفة الطبية:</strong>
                            ${treatment.medications.map(med => `
                                <div class="medication-list-item">
                                    <span>${med.name}</span>
                                    <span>${med.dose} - ${med.frequency}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="treatment-actions">
                    <button onclick="generateReport('${treatment.id}')" class="btn btn-success">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button onclick="closeTreatmentDetails()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> إغلاق
                    </button>
                </div>
            `;
            
            // إنشاء نافذة عرض التفاصيل
            const detailsModal = document.createElement('div');
            detailsModal.className = 'modal';
            detailsModal.id = 'details-modal';
            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">تفاصيل العلاج</h3>
                        <button class="close-btn" onclick="closeTreatmentDetails()">&times;</button>
                    </div>
                    ${detailsHtml}
                </div>
            `;
            
            document.body.appendChild(detailsModal);
            detailsModal.style.display = 'block';
        }
        
        // إغلاق نافذة تفاصيل العلاج
        function closeTreatmentDetails() {
            const modal = document.getElementById('details-modal');
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        // إعداد اختيار الأسنان
        function setupTeethSelection() {
            const teeth = document.querySelectorAll('.tooth');
            teeth.forEach(tooth => {
                tooth.addEventListener('click', function() {
                    const toothNumber = this.getAttribute('data-number');
                    this.classList.toggle('treated');
                    
                    if (this.classList.contains('treated')) {
                        if (!treatedTeeth.includes(toothNumber)) {
                            treatedTeeth.push(toothNumber);
                        }
                    } else {
                        treatedTeeth = treatedTeeth.filter(num => num !== toothNumber);
                    }
                    
                    document.getElementById('treated-teeth').value = treatedTeeth.join(',');
                });
            });
        }
        
        // إعداد الوصفات الطبية
        function setupMedications() {
            // إضافة دواء جديد
            document.getElementById('add-medication').addEventListener('click', function() {
                addMedicationField();
            });
            
            // إضافة حقل دواء افتراضي عند التحميل
            addMedicationField();
        }
        
        // إضافة حقل دواء جديد
        function addMedicationField(medication = { name: '', dose: '', frequency: '' }) {
            const container = document.getElementById('medications-container');
            const medId = Date.now();
            
            const medElement = document.createElement('div');
            medElement.className = 'medication-item';
            medElement.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label for="med-name-${medId}">اسم الدواء</label>
                        <input type="text" id="med-name-${medId}" class="form-control" value="${medication.name}" placeholder="اسم الدواء">
                    </div>
                    <div class="form-group">
                        <label for="med-dose-${medId}">الجرعة</label>
                        <input type="text" id="med-dose-${medId}" class="form-control" value="${medication.dose}" placeholder="مثال: 500mg">
                    </div>
                    <div class="form-group">
                        <label for="med-frequency-${medId}">عدد المرات</label>
                        <input type="text" id="med-frequency-${medId}" class="form-control" value="${medication.frequency}" placeholder="مثال: 3 مرات يومياً">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeMedication(this)" style="margin-top: 10px;">
                    <i class="fas fa-trash"></i> حذف الدواء
                </button>
            `;
            
            container.appendChild(medElement);
        }
        
        // حذف دواء من القائمة
        function removeMedication(button) {
            if (document.querySelectorAll('.medication-item').length > 1) {
                button.closest('.medication-item').remove();
            } else {
                alert('يجب أن يحتوي العلاج على دواء واحد على الأقل');
            }
        }
        
        // جمع بيانات الأدوية
        function getMedicationsData() {
            const medications = [];
            const medicationItems = document.querySelectorAll('.medication-item');
            
            medicationItems.forEach(item => {
                const id = item.querySelector('input').id.split('-')[2];
                medications.push({
                    name: document.getElementById(`med-name-${id}`).value,
                    dose: document.getElementById(`med-dose-${id}`).value,
                    frequency: document.getElementById(`med-frequency-${id}`).value
                });
            });
            
            return medications;
        }
        
        // حفظ العلاج في قاعدة البيانات
        function saveTreatment() {
            const patientId = document.getElementById('patient-select').value;
            const treatmentType = document.getElementById('treatment-type').value;
            const date = document.getElementById('treatment-date').value;
            const notes = document.getElementById('treatment-notes').value;
            const treatedTeethStr = document.getElementById('treated-teeth').value;
            const medications = getMedicationsData();
            
            if (!patientId || !treatmentType || !date) {
                alert('الرجاء إدخال جميع الحقول المطلوبة');
                return;
            }
            
            // التحقق من وجود دواء على الأقل
            if (medications.length === 0 || medications.some(med => !med.name)) {
                alert('الرجاء إدخال وصفة طبية تحتوي على دواء واحد على الأقل');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                alert('المريض غير موجود');
                return;
            }
            
            const treatmentData = {
                patientId,
                patientName: patient.name,
                patientPhone: patient.phone,
                type: treatmentType,
                date,
                treatedTeeth: treatedTeethStr,
                notes: notes || '',
                medications: medications,
                createdAt: new Date().toISOString()
            };
            
            // إنشاء معرف فريد للعلاج
            const treatmentId = database.ref().child('Watine/treatments').push().key;
            
            // حفظ البيانات في Firebase
            database.ref('Watine/treatments/' + treatmentId).set(treatmentData)
                .then(() => {
                    alert('تم حفظ العلاج بنجاح');
                    resetForm();
                    loadTreatments();
                    generateReport(treatmentId, treatmentData);
                })
                .catch(error => {
                    alert('حدث خطأ أثناء حفظ العلاج: ' + error.message);
                    console.error("Error saving treatment:", error);
                });
        }
        
        // تعديل العلاج
        function editTreatment(treatmentId) {
            const treatment = treatments.find(t => t.id === treatmentId);
            if (!treatment) return;
            
            // حفظ معرف العلاج الحالي
            currentTreatmentId = treatmentId;
            isEditing = true;
            
            // تعبئة النموذج ببيانات العلاج
            document.getElementById('treatment-id').value = treatmentId;
            $('#patient-select').val(treatment.patientId).trigger('change');
            document.getElementById('treatment-type').value = treatment.type;
            document.getElementById('treatment-date').value = treatment.date;
            document.getElementById('treatment-notes').value = treatment.notes || '';
            
            // تعبئة الأسنان المعالجة
            treatedTeeth = treatment.treatedTeeth ? treatment.treatedTeeth.split(',') : [];
            document.getElementById('treated-teeth').value = treatedTeeth.join(',');
            
            // تحديث واجهة الأسنان المعالجة
            document.querySelectorAll('.tooth').forEach(tooth => {
                const toothNumber = tooth.getAttribute('data-number');
                if (treatedTeeth.includes(toothNumber)) {
                    tooth.classList.add('treated');
                } else {
                    tooth.classList.remove('treated');
                }
            });
            
            // تعبئة الأدوية
            const medContainer = document.getElementById('medications-container');
            medContainer.innerHTML = '';
            
            if (treatment.medications && treatment.medications.length > 0) {
                treatment.medications.forEach(med => {
                    addMedicationField(med);
                });
            } else {
                addMedicationField();
            }
            
            // تبديل أزرار الحفظ والتحديث
            document.getElementById('save-treatment').style.display = 'none';
            document.getElementById('update-treatment').style.display = 'inline-flex';
            document.getElementById('cancel-edit').style.display = 'inline-flex';
            
            // التمرير إلى أعلى النموذج
            document.getElementById('treatment-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // تحديث العلاج
        function updateTreatment() {
            if (!currentTreatmentId) return;
            
            const patientId = document.getElementById('patient-select').value;
            const treatmentType = document.getElementById('treatment-type').value;
            const date = document.getElementById('treatment-date').value;
            const notes = document.getElementById('treatment-notes').value;
            const treatedTeethStr = document.getElementById('treated-teeth').value;
            const medications = getMedicationsData();
            
            if (!patientId || !treatmentType || !date) {
                alert('الرجاء إدخال جميع الحقول المطلوبة');
                return;
            }
            
            // التحقق من وجود دواء على الأقل
            if (medications.length === 0 || medications.some(med => !med.name)) {
                alert('الرجاء إدخال وصفة طبية تحتوي على دواء واحد على الأقل');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                alert('المريض غير موجود');
                return;
            }
            
            const treatmentData = {
                patientId,
                patientName: patient.name,
                patientPhone: patient.phone,
                type: treatmentType,
                date,
                treatedTeeth: treatedTeethStr,
                notes: notes || '',
                medications: medications,
                updatedAt: new Date().toISOString()
            };
            
            // تحديث البيانات في Firebase
            database.ref('Watine/treatments/' + currentTreatmentId).update(treatmentData)
                .then(() => {
                    alert('تم تحديث العلاج بنجاح');
                    resetForm();
                    loadTreatments();
                })
                .catch(error => {
                    alert('حدث خطأ أثناء تحديث العلاج: ' + error.message);
                    console.error("Error updating treatment:", error);
                });
        }
        
        // إلغاء التعديل
        function cancelEdit() {
            resetForm();
        }
        
        // إعادة تعيين النموذج
        function resetForm() {
            document.getElementById('treatment-form').reset();
            document.getElementById('treatment-id').value = '';
            document.getElementById('treated-teeth').value = '';
            $('#patient-select').val('').trigger('change');
            
            // إعادة تعيين تاريخ اليوم
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('treatment-date').value = today;
            
            // إعادة تعيين الأسنان المعالجة
            treatedTeeth = [];
            document.querySelectorAll('.tooth').forEach(tooth => {
                tooth.classList.remove('treated');
            });
            
            // إعادة تعيين الأدوية
            const medContainer = document.getElementById('medications-container');
            medContainer.innerHTML = '';
            addMedicationField();
            
            // تبديل الأزرار إلى وضعها الطبيعي
            document.getElementById('save-treatment').style.display = 'inline-flex';
            document.getElementById('update-treatment').style.display = 'none';
            document.getElementById('cancel-edit').style.display = 'none';
            
            isEditing = false;
            currentTreatmentId = null;
        }
        
        // حذف العلاج
        function deleteTreatment(treatmentId) {
            if (!confirm('هل أنت متأكد من حذف هذا العلاج؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            database.ref('Watine/treatments/' + treatmentId).remove()
                .then(() => {
                    loadTreatments();
                })
                .catch(error => {
                    alert('حدث خطأ أثناء حذف العلاج');
                    console.error("Error deleting treatment:", error);
                });
        }
        
        // تصفية العلاجات حسب البحث
        function filterTreatments() {
            const searchTerm = document.getElementById('search-treatments').value.toLowerCase();
            const dateFilter = document.getElementById('filter-date').value;
            
            let filteredTreatments = treatments;
            
            // التصفية حسب تاريخ العلاج
            if (dateFilter) {
                filteredTreatments = filteredTreatments.filter(t => t.date === dateFilter);
            }
            
            // البحث باسم المريض أو نوع العلاج
            if (searchTerm) {
                filteredTreatments = filteredTreatments.filter(treatment => {
                    const patient = patients.find(p => p.id === treatment.patientId) || { name: '', phone: '' };
                    return (
                        patient.name.toLowerCase().includes(searchTerm) ||
                        patient.phone.includes(searchTerm) ||
                        treatment.type.toLowerCase().includes(searchTerm) ||
                        (treatment.notes && treatment.notes.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            displayTreatments(filteredTreatments);
        }
        
        // إنشاء تقرير العلاج
        function generateReport(treatmentId, treatmentData = null) {
            let treatment = treatmentData;
            
            if (!treatment) {
                treatment = treatments.find(t => t.id === treatmentId);
                if (!treatment) return;
            }
            
            const patient = patients.find(p => p.id === treatment.patientId) || {
                name: 'مريض غير معروف',
                phone: 'غير متوفر'
            };
            
            const reportDate = treatment.date ? formatDateWithForeignNumbers(new Date(treatment.date)) : formatDateWithForeignNumbers(new Date());
            const treatedTeethList = treatment.treatedTeeth ? treatment.treatedTeeth.split(',') : [];
            
            const reportContent = `
                <div class="report-header">
                    <img src="https://i.ibb.co/ZzrbF0P4/SVG.png" alt="شعار العيادة" class="report-logo">
                    <div class="clinic-name">عيادة وتين لطب الأسنان</div>
                    <div class="doctor-info">الدكتورة: ربيقة شيماء زوجة قرناني</div>
                    <div class="clinic-address"><i class="fas fa-map-marker-alt"></i> حي العزامية عين ازال</div>
                    <div style="font-size: 18px; font-weight: 600;">تقرير العلاج</div>
                </div>
                
                <div class="report-patient">
                    <div>
                        <div class="report-row">
                            <span class="report-label">اسم المريض:</span>
                            <span class="report-value">${patient.name}</span>
                        </div>
                        <div class="report-row">
                            <span class="report-label">رقم الهاتف:</span>
                            <span class="report-value">${patient.phone}</span>
                        </div>
                    </div>
                    <div>
                        <div class="report-row">
                            <span class="report-label">رقم التقرير:</span>
                            <span class="report-value">${treatmentId.substring(0, 8)}</span>
                        </div>
                        <div class="report-row">
                            <span class="report-label">تاريخ العلاج:</span>
                            <span class="report-value">${reportDate}</span>
                        </div>
                    </div>
                </div>
                
                <div class="report-details">
                    <h3 class="report-title">تفاصيل العلاج</h3>
                    
                    <div class="report-row">
                        <span class="report-label">نوع العلاج:</span>
                        <span class="report-value">${treatment.type}</span>
                    </div>
                    
                    ${treatedTeethList.length > 0 ? `
                        <div class="report-teeth">
                            <div class="report-teeth-title">الأسنان المعالجة:</div>
                            <div class="report-teeth-list">
                                ${treatedTeethList.map(tooth => `
                                    <span class="report-tooth">${tooth}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${treatment.notes ? `
                        <div class="report-row">
                            <span class="report-label">ملاحظات:</span>
                            <span class="report-value">${treatment.notes}</span>
                        </div>
                    ` : ''}
                </div>
                
                ${treatment.medications && treatment.medications.length > 0 ? `
                    <div class="report-medications">
                        <h3 class="report-title">الوصفة الطبية</h3>
                        
                        ${treatment.medications.map(med => `
                            <div class="report-medication">
                                <span><strong>${med.name}</strong></span>
                                <span>${med.dose} - ${med.frequency}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="report-footer">
                    <p>شكراً لثقتكم بنا</p>
                    <p>للاستفسار: 0555555555</p>
                    <p>هذا التقرير صادر عن عيادة وتين لطب الأسنان</p>
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = reportContent;
            document.getElementById('report-modal').style.display = 'block';
        }
        
        // طباعة التقرير الكامل
        function printReport() {
            document.getElementById('report-content').classList.remove('prescription-only');
            window.print();
        }
        
        // طباعة الوصفة الطبية فقط
        function printPrescriptionOnly() {
            const treatmentId = currentTreatmentId || document.getElementById('treatment-id').value;
            const treatment = treatments.find(t => t.id === treatmentId);
            
            if (!treatment || !treatment.medications || treatment.medications.length === 0) {
                alert('لا توجد وصفة طبية لطباعتها');
                return;
            }
            
            const prescriptionContent = `
                <div class="report-header">
                    <img src="https://i.ibb.co/ZzrbF0P4/SVG.png" alt="شعار العيادة" class="report-logo">
                    <div class="clinic-name">عيادة وتين لطب الأسنان</div>
                    <div class="doctor-info">الدكتورة: ربيقة شيماء زوجة قرناني</div>
                    <div class="clinic-address"><i class="fas fa-map-marker-alt"></i> حي العزامية عين ازال</div>
                    <h3 class="report-title">الوصفة الطبية</h3>
                </div>
                
                <div class="report-patient">
                    <div class="report-row">
                        <span class="report-label">اسم المريض:</span>
                        <span class="report-value">${treatment.patientName}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">تاريخ الوصفة:</span>
                        <span class="report-value">${formatDateWithForeignNumbers(new Date(treatment.date))}</span>
                    </div>
                </div>
                
                <div class="report-medications prescription-only">
                    ${treatment.medications.map(med => `
                        <div class="report-medication">
                            <span><strong>${med.name}</strong></span>
                            <span>${med.dose}</span>
                            <span>${med.frequency}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="report-footer">
                    <p>توقيع الطبيب: _________________________</p>
                    <p>ختم العيادة</p>
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = prescriptionContent;
            document.getElementById('report-content').classList.add('prescription-only');
            window.print();
            generateReport(treatmentId); // إعادة عرض التقرير الكامل بعد الطباعة
        }
        
        // إغلاق نافذة التقرير
        function closeReportModal() {
            document.getElementById('report-modal').style.display = 'none';
        }
        
        // تنسيق التاريخ بأرقام أجنبية
        function formatDateWithForeignNumbers(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                numberingSystem: 'latn'
            };
            
            let formattedDate = date.toLocaleDateString('ar-EG', options);
            
            // استبدال الأرقام العربية بأجنبية (في حالة عدم دعم numberingSystem)
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            for (let i = 0; i < arabicNumbers.length; i++) {
                formattedDate = formattedDate.replace(new RegExp(arabicNumbers[i], 'g'), i);
            }
            
            return formattedDate;
        }
    </script>
</body>
</html>
