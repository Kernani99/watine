<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المدفوعات - عيادة واتين للأسنان</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #a76dac;
            --secondary: #8e44ad;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light-pink: #f8e1f4;
            --light-purple: #f3e5f5;
            --dark: #4a235a;
            --light: #f9f9f9;
            --gray: #95a5a6;
            --white: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #fdf5fd;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .clinic-logo {
            height: 70px;
            width: auto;
        }
        
        .header-text {
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 700;
            color: white;
        }
        
        .header-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .card {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-pink);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0c8e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background-color: var(--light-pink);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(167, 109, 172, 0.2);
            background-color: white;
        }
        
        .select2-container--default .select2-selection--single {
            border: 1px solid #e0c8e0;
            border-radius: 10px;
            height: auto;
            padding: 10px;
            background-color: var(--light-pink);
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100%;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn i {
            margin-left: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .btn-pink {
            background-color: #f8bbd0;
            color: #880e4f;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .payment-card {
            border-left: 4px solid var(--primary);
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.03);
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .payment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .payment-card.pending {
            border-left-color: var(--warning);
            background-color: rgba(243, 156, 18, 0.03);
        }
        
        .payment-card.completed {
            border-left-color: var(--success);
            background-color: rgba(39, 174, 96, 0.03);
        }
        
        .payment-card.refunded {
            border-left-color: var(--danger);
            background-color: rgba(231, 76, 60, 0.03);
        }
        
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #f0e6ef;
        }
        
        .payment-patient {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .patient-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .payment-status-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .payment-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }
        
        .status-pending {
            background-color: var(--warning);
        }
        
        .status-completed {
            background-color: var(--success);
        }
        
        .status-refunded {
            background-color: var(--danger);
        }
        
        .payment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .payment-amount {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .payment-date {
            color: var(--gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .payment-notes {
            margin-top: 15px;
            padding: 12px;
            background-color: var(--light-pink);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .payment-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0e6ef;
        }
        
        .modal-title {
            font-size: 22px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--danger);
        }
        
        /* وصل الدفع */
        .receipt {
            background-color: white;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            border: 1px solid #f0e6ef;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px dashed #f0e6ef;
        }
        
        .clinic-name {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .receipt-logo {
            height: 60px;
            margin-bottom: 15px;
        }
        
        .receipt-details {
            margin: 25px 0;
        }
        
        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .receipt-label {
            font-weight: 600;
            color: var(--gray);
        }
        
        .receipt-value {
            font-weight: 500;
        }
        
        .receipt-amount {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 30px 0;
            padding: 15px 0;
            border-top: 2px dashed #f0e6ef;
            border-bottom: 2px dashed #f0e6ef;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #f0e6ef;
            font-size: 14px;
            color: var(--gray);
        }
        
        /* تأثيرات خاصة */
        .floral-decoration {
            position: absolute;
            opacity: 0.1;
            z-index: 0;
        }
        
        .floral-1 {
            top: 20px;
            left: 20px;
            transform: rotate(30deg);
        }
        
        .floral-2 {
            bottom: 20px;
            right: 20px;
            transform: rotate(-20deg);
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt, .receipt * {
                visibility: visible;
            }
            .receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-details {
                grid-template-columns: 1fr;
            }
            
            .payment-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .payment-status-container {
                align-self: flex-end;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .clinic-logo {
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="https://i.ibb.co/ZzrbF0P4/SVG.png" alt="شعار العيادة" class="clinic-logo">
            <div class="header-text">
                <h1><i class="fas fa-money-bill-wave"></i> نظام إدارة المدفوعات</h1>
                <div class="header-info">
                    <span><i class="fas fa-hospital"></i> عيادة واتين للأسنان</span>
                    <span><i class="fas fa-map-marker-alt"></i> الجزائر - الجزائر</span>
                </div>
            </div>
        </div>
        <i class="fas fa-heart floral-decoration floral-1" style="color: var(--primary); font-size: 40px;"></i>
        <i class="fas fa-spa floral-decoration floral-2" style="color: var(--primary); font-size: 40px;"></i>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title"><i class="fas fa-plus-circle" style="color: var(--primary);"></i> تسجيل دفعة جديدة</h2>
            <form id="payment-form">
                <input type="hidden" id="payment-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="patient-select"><i class="fas fa-user-injured" style="margin-left: 5px;"></i> المريض</label>
                        <select id="patient-select" class="form-control" required style="width: 100%">
                            <option value="">اختر المريض...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-amount"><i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> المبلغ (دينار جزائري)</label>
                        <input type="number" id="payment-amount" class="form-control" placeholder="أدخل المبلغ" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-status"><i class="fas fa-info-circle" style="margin-left: 5px;"></i> حالة الدفع</label>
                        <select id="payment-status" class="form-control" required>
                            <option value="pending">قيد الانتظار</option>
                            <option value="completed">مكتمل</option>
                            <option value="refunded">مسترد</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-date"><i class="far fa-calendar-alt" style="margin-left: 5px;"></i> تاريخ الدفع</label>
                        <input type="date" id="payment-date" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-calendar-week" style="margin-left: 5px;"></i> هل الدفع على دفعات؟</label>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="installment" value="no" checked> دفعة واحدة
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="installment" value="yes"> دفعات
                        </label>
                    </div>
                </div>
                
                <div id="installment-details" style="display: none; margin-top: 15px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="total-amount"><i class="fas fa-calculator" style="margin-left: 5px;"></i> المبلغ الإجمالي</label>
                            <input type="number" id="total-amount" class="form-control" placeholder="المبلغ الكامل">
                        </div>
                        <div class="form-group">
                            <label for="remaining-amount"><i class="fas fa-coins" style="margin-left: 5px;"></i> المبلغ المتبقي</label>
                            <input type="number" id="remaining-amount" class="form-control" placeholder="المتبقي للدفع">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="payment-notes"><i class="far fa-sticky-note" style="margin-left: 5px;"></i> ملاحظات</label>
                    <textarea id="payment-notes" class="form-control" rows="3" placeholder="أي ملاحظات إضافية..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button type="button" id="save-payment" class="btn btn-primary">
                        <i class="fas fa-save"></i> حفظ الدفعة
                    </button>
                    <button type="button" id="update-payment" class="btn btn-warning" style="display: none;">
                        <i class="fas fa-sync-alt"></i> تحديث الدفعة
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> إعادة تعيين
                    </button>
                    <button type="button" id="cancel-edit" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
            </form>
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-history" style="color: var(--primary);"></i> سجل المدفوعات</h2>
            
            <div style="margin-bottom: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <input type="text" id="search-payments" class="form-control" placeholder="ابحث باسم المريض أو المبلغ...">
                    </div>
                    <div class="form-group">
                        <select id="filter-status" class="form-control">
                            <option value="all">جميع الحالات</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="completed">مكتمل</option>
                            <option value="refunded">مسترد</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="date" id="filter-date" class="form-control">
                    </div>
                </div>
            </div>
            
            <div id="payments-list">
                <p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> جاري تحميل سجل المدفوعات...</p>
            </div>
        </div>
    </div>
    
    <!-- نافذة عرض وصل الدفع -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-receipt" style="color: var(--primary);"></i> وصل الدفع</h3>
                <button class="close-btn" onclick="closeReceiptModal()">&times;</button>
            </div>
            <div id="receipt-content" class="receipt">
                <!-- سيتم تعبئته بواسطة JavaScript -->
            </div>
            <div class="action-buttons no-print" style="justify-content: center; margin-top: 20px;">
                <button onclick="printReceipt()" class="btn btn-primary">
                    <i class="fas fa-print"></i> طباعة الوصل
                </button>
                <button onclick="closeReceiptModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- مكتبات JavaScript -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            databaseURL: "https://watine-b8878-default-rtdb.firebaseio.com/"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // متغيرات التطبيق
        let patients = [];
        let payments = [];
        let isEditing = false;
        let currentPaymentId = null;
        
        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين تاريخ اليوم كقيمة افتراضية
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // تهيئة Select2 لبحث المرضى
            $('#patient-select').select2({
                placeholder: "ابحث عن مريض...",
                allowClear: true,
                width: '100%',
                language: {
                    noResults: function() {
                        return "لا توجد نتائج";
                    }
                }
            });
            
            // تحميل قائمة المرضى
            loadPatients();
            
            // تحميل سجل المدفوعات
            loadPayments();
            
            // إظهار/إخفاء تفاصيل الدفعات
            document.querySelectorAll('input[name="installment"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('installment-details').style.display = 
                        this.value === 'yes' ? 'block' : 'none';
                });
            });
            
            // حفظ الدفعة
            document.getElementById('save-payment').addEventListener('click', savePayment);
            
            // تحديث الدفعة
            document.getElementById('update-payment').addEventListener('click', updatePayment);
            
            // إلغاء التعديل
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // البحث والتصفية
            document.getElementById('search-payments').addEventListener('input', filterPayments);
            document.getElementById('filter-status').addEventListener('change', filterPayments);
            document.getElementById('filter-date').addEventListener('change', filterPayments);
        });
        
        // تحميل قائمة المرضى
        function loadPatients() {
            $('#patient-select').html('<option value="">جاري تحميل المرضى...</option>');
            
            database.ref('/Watine/patients').once('value')
                .then(snapshot => {
                    patients = [];
                    $('#patient-select').empty().append('<option value="">اختر المريض...</option>');
                    
                    const patientsData = snapshot.val();
                    if (patientsData) {
                        Object.entries(patientsData).forEach(([id, patient]) => {
                            if (patient.name && patient.phone) {
                                const option = new Option(`${patient.name} - ${patient.phone}`, id);
                                $('#patient-select').append(option);
                                patients.push({ id, ...patient });
                            }
                        });
                    }
                    $('#patient-select').trigger('change');
                })
                .catch(error => {
                    console.error("Error loading patients:", error);
                    $('#patient-select').html('<option value="">حدث خطأ في تحميل المرضى</option>');
                });
        }
        
        // تحميل سجل المدفوعات
        function loadPayments() {
            const paymentsList = document.getElementById('payments-list');
            paymentsList.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> جاري تحميل سجل المدفوعات...</p>';
            
            database.ref('/Watine/payments').orderByChild('date').once('value')
                .then(snapshot => {
                    payments = [];
                    paymentsList.innerHTML = '';
                    
                    const paymentsData = snapshot.val();
                    if (paymentsData) {
                        Object.entries(paymentsData).forEach(([id, payment]) => {
                            if (payment.patientId && payment.amount) {
                                payments.push({ id, ...payment });
                            }
                        });
                        
                        // عرض المدفوعات بعد الفرز من الأحدث إلى الأقدم
                        displayPayments(payments.reverse());
                    } else {
                        paymentsList.innerHTML = '<p style="text-align: center;">لا توجد مدفوعات مسجلة بعد</p>';
                    }
                })
                .catch(error => {
                    console.error("Error loading payments:", error);
                    paymentsList.innerHTML = '<p style="text-align: center;" class="error">حدث خطأ في تحميل المدفوعات</p>';
                });
        }
        
        // عرض المدفوعات في القائمة
        function displayPayments(paymentsToDisplay) {
            const paymentsList = document.getElementById('payments-list');
            
            if (paymentsToDisplay.length === 0) {
                paymentsList.innerHTML = '<p style="text-align: center;">لا توجد مدفوعات تطابق معايير البحث</p>';
                return;
            }
            
            paymentsList.innerHTML = '';
            
            paymentsToDisplay.forEach(payment => {
                const patient = patients.find(p => p.id === payment.patientId) || {
                    name: 'مريض غير معروف',
                    phone: 'غير متوفر'
                };
                
                const paymentDate = payment.date ? formatDateWithForeignNumbers(new Date(payment.date)) : 'غير محدد';
                const statusClass = payment.status || 'pending';
                const statusText = getStatusText(payment.status);
                
                const paymentElement = document.createElement('div');
                paymentElement.className = `payment-card ${statusClass}`;
                paymentElement.innerHTML = `
                    <div class="payment-header">
                        <div class="payment-patient">
                            <div class="patient-avatar">
                                ${patient.name.charAt(0)}
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0;">${patient.name}</h4>
                                <small>${patient.phone}</small>
                            </div>
                        </div>
                        <div class="payment-status-container">
                            <span class="payment-status status-${statusClass}">
                                <i class="fas fa-${getStatusIcon(payment.status)}"></i> ${statusText}
                            </span>
                        </div>
                    </div>
                    
                    <div class="payment-details">
                        <div>
                            <span class="payment-amount">${payment.amount} د.ج</span>
                            ${payment.installment === 'yes' ? 
                              `<small style="display: block; color: var(--gray);">دفعة من ${payment.totalAmount} د.ج</small>` : ''}
                        </div>
                        <div>
                            <span class="payment-date"><i class="far fa-calendar-alt"></i> ${paymentDate}</span>
                        </div>
                    </div>
                    
                    ${payment.notes ? `
                        <div class="payment-notes">
                            <strong>ملاحظات:</strong> ${payment.notes}
                        </div>
                    ` : ''}
                    
                    <div class="payment-actions no-print">
                        <button onclick="editPayment('${payment.id}')" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button onclick="deletePayment('${payment.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                        <button onclick="printSingleReceipt('${payment.id}')" class="btn btn-success btn-sm">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                    </div>
                `;
                
                paymentsList.appendChild(paymentElement);
            });
        }
        
        // حفظ الدفعة في قاعدة البيانات
        function savePayment() {
            const patientId = document.getElementById('patient-select').value;
            const amount = document.getElementById('payment-amount').value;
            const status = document.getElementById('payment-status').value;
            const date = document.getElementById('payment-date').value;
            const installment = document.querySelector('input[name="installment"]:checked').value;
            const notes = document.getElementById('payment-notes').value;
            
            if (!patientId || !amount || !date) {
                alert('الرجاء إدخال جميع الحقول المطلوبة');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                alert('المريض غير موجود');
                return;
            }
            
            const paymentData = {
                patientId,
                patientName: patient.name,
                patientPhone: patient.phone,
                amount: parseFloat(amount),
                status,
                date,
                installment,
                notes: notes || '',
                createdAt: new Date().toISOString()
            };
            
            // إذا كانت دفعة على أقساط
            if (installment === 'yes') {
                paymentData.totalAmount = document.getElementById('total-amount').value || amount;
                paymentData.remainingAmount = document.getElementById('remaining-amount').value || 
                    (paymentData.totalAmount - amount);
            }
            
            // إنشاء معرف فريد للدفعة
            const paymentId = database.ref().child('Watine/payments').push().key;
            
            // حفظ البيانات في Firebase
            database.ref('Watine/payments/' + paymentId).set(paymentData)
                .then(() => {
                    alert('تم حفظ الدفعة بنجاح');
                    resetForm();
                    loadPayments();
                    generateReceipt(paymentId, { ...paymentData, id: paymentId });
                })
                .catch(error => {
                    alert('حدث خطأ أثناء حفظ الدفعة: ' + error.message);
                    console.error("Error saving payment:", error);
                });
        }
        
        // تعديل الدفعة
        function editPayment(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            // حفظ معرف الدفعة الحالية
            currentPaymentId = paymentId;
            isEditing = true;
            
            // تعبئة النموذج ببيانات الدفعة
            document.getElementById('payment-id').value = paymentId;
            $('#patient-select').val(payment.patientId).trigger('change');
            document.getElementById('payment-amount').value = payment.amount;
            document.getElementById('payment-status').value = payment.status;
            document.getElementById('payment-date').value = payment.date;
            document.querySelector(`input[name="installment"][value="${payment.installment || 'no'}"]`).checked = true;
            
            if (payment.installment === 'yes') {
                document.getElementById('installment-details').style.display = 'block';
                document.getElementById('total-amount').value = payment.totalAmount || '';
                document.getElementById('remaining-amount').value = payment.remainingAmount || '';
            } else {
                document.getElementById('installment-details').style.display = 'none';
            }
            
            document.getElementById('payment-notes').value = payment.notes || '';
            
            // تبديل أزرار الحفظ والتحديث
            document.getElementById('save-payment').style.display = 'none';
            document.getElementById('update-payment').style.display = 'inline-flex';
            document.getElementById('cancel-edit').style.display = 'inline-flex';
            
            // التمرير إلى أعلى النموذج
            document.getElementById('payment-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // تحديث الدفعة
        function updatePayment() {
            if (!currentPaymentId) return;
            
            const patientId = document.getElementById('patient-select').value;
            const amount = document.getElementById('payment-amount').value;
            const status = document.getElementById('payment-status').value;
            const date = document.getElementById('payment-date').value;
            const installment = document.querySelector('input[name="installment"]:checked').value;
            const notes = document.getElementById('payment-notes').value;
            
            if (!patientId || !amount || !date) {
                alert('الرجاء إدخال جميع الحقول المطلوبة');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                alert('المريض غير موجود');
                return;
            }
            
            const paymentData = {
                patientId,
                patientName: patient.name,
                patientPhone: patient.phone,
                amount: parseFloat(amount),
                status,
                date,
                installment,
                notes: notes || '',
                updatedAt: new Date().toISOString()
            };
            
            // إذا كانت دفعة على أقساط
            if (installment === 'yes') {
                paymentData.totalAmount = document.getElementById('total-amount').value || amount;
                paymentData.remainingAmount = document.getElementById('remaining-amount').value || 
                    (paymentData.totalAmount - amount);
            }
            
            // تحديث البيانات في Firebase
            database.ref('Watine/payments/' + currentPaymentId).update(paymentData)
                .then(() => {
                    alert('تم تحديث الدفعة بنجاح');
                    resetForm();
                    loadPayments();
                })
                .catch(error => {
                    alert('حدث خطأ أثناء تحديث الدفعة: ' + error.message);
                    console.error("Error updating payment:", error);
                });
        }
        
        // إلغاء التعديل
        function cancelEdit() {
            resetForm();
        }
        
        // إعادة تعيين النموذج
        function resetForm() {
            document.getElementById('payment-form').reset();
            document.getElementById('payment-id').value = '';
            document.getElementById('installment-details').style.display = 'none';
            $('#patient-select').val('').trigger('change');
            
            // إعادة تعيين تاريخ اليوم
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // تبديل الأزرار إلى وضعها الطبيعي
            document.getElementById('save-payment').style.display = 'inline-flex';
            document.getElementById('update-payment').style.display = 'none';
            document.getElementById('cancel-edit').style.display = 'none';
            
            isEditing = false;
            currentPaymentId = null;
        }
        
        // حذف الدفعة
        function deletePayment(paymentId) {
            if (!confirm('هل أنت متأكد من حذف هذه الدفعة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            database.ref('Watine/payments/' + paymentId).remove()
                .then(() => {
                    loadPayments();
                })
                .catch(error => {
                    alert('حدث خطأ أثناء حذف الدفعة');
                    console.error("Error deleting payment:", error);
                });
        }
        
        // تصفية المدفوعات حسب البحث
        function filterPayments() {
            const searchTerm = document.getElementById('search-payments').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const dateFilter = document.getElementById('filter-date').value;
            
            let filteredPayments = payments;
            
            // التصفية حسب حالة الدفع
            if (statusFilter !== 'all') {
                filteredPayments = filteredPayments.filter(p => p.status === statusFilter);
            }
            
            // التصفية حسب تاريخ الدفع
            if (dateFilter) {
                filteredPayments = filteredPayments.filter(p => p.date === dateFilter);
            }
            
            // البحث باسم المريض أو المبلغ
            if (searchTerm) {
                filteredPayments = filteredPayments.filter(payment => {
                    const patient = patients.find(p => p.id === payment.patientId) || { name: '', phone: '' };
                    return (
                        patient.name.toLowerCase().includes(searchTerm) ||
                        patient.phone.includes(searchTerm) ||
                        payment.amount.toString().includes(searchTerm) ||
                        (payment.notes && payment.notes.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            displayPayments(filteredPayments);
        }
        
        // إنشاء وصل الدفع
        function generateReceipt(paymentId, paymentData) {
            const patient = patients.find(p => p.id === paymentData.patientId) || {
                name: 'مريض غير معروف',
                phone: 'غير متوفر'
            };
            
            const receiptDate = paymentData.date ? formatDateWithForeignNumbers(new Date(paymentData.date)) : formatDateWithForeignNumbers(new Date());
            const statusText = getStatusText(paymentData.status);
            
            const receiptContent = `
                <div class="receipt-header">
                    <img src="https://i.ibb.co/ZzrbF0P4/SVG.png" alt="شعار العيادة" class="receipt-logo">
                    <div class="clinic-name">عيادة واتين للأسنان</div>
                    <div style="color: var(--gray); margin-bottom: 10px;">
                        <i class="fas fa-map-marker-alt"></i> الجزائر - الجزائر
                    </div>
                    <div style="font-size: 18px; font-weight: 600;">وصل استلام دفعة</div>
                </div>
                
                <div class="receipt-details">
                    <div class="receipt-row">
                        <span class="receipt-label">رقم الوصل:</span>
                        <span class="receipt-value">${paymentId.substring(0, 8)}</span>
                    </div>
                    <div class="receipt-row">
                        <span class="receipt-label">تاريخ الوصل:</span>
                        <span class="receipt-value">${receiptDate}</span>
                    </div>
                    <div class="receipt-row">
                        <span class="receipt-label">اسم المريض:</span>
                        <span class="receipt-value">${patient.name}</span>
                    </div>
                    <div class="receipt-row">
                        <span class="receipt-label">هاتف المريض:</span>
                        <span class="receipt-value">${patient.phone}</span>
                    </div>
                    <div class="receipt-row">
                        <span class="receipt-label">حالة الدفع:</span>
                        <span class="receipt-value">${statusText}</span>
                    </div>
                    
                    ${paymentData.installment === 'yes' ? `
                        <div class="receipt-row">
                            <span class="receipt-label">نوع الدفع:</span>
                            <span class="receipt-value">دفعات</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">المبلغ الإجمالي:</span>
                            <span class="receipt-value">${paymentData.totalAmount || paymentData.amount} د.ج</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">المبلغ المدفوع:</span>
                            <span class="receipt-value">${paymentData.amount} د.ج</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">المبلغ المتبقي:</span>
                            <span class="receipt-value">${paymentData.remainingAmount || (paymentData.totalAmount - paymentData.amount)} د.ج</span>
                        </div>
                    ` : `
                        <div class="receipt-row">
                            <span class="receipt-label">نوع الدفع:</span>
                            <span class="receipt-value">دفعة واحدة</span>
                        </div>
                    `}
                    
                    ${paymentData.notes ? `
                        <div class="receipt-row">
                            <span class="receipt-label">ملاحظات:</span>
                            <span class="receipt-value">${paymentData.notes}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="receipt-amount">
                    المبلغ: ${paymentData.amount} دينار جزائري
                </div>
                
                <div class="receipt-footer">
                    <p>شكراً لثقتكم بنا</p>
                    <p>هذا الوصل ليس له أي قيمة مالية بدون ختم العيادة</p>
                    <p>للاستفسار: 0555555555</p>
                </div>
            `;
            
            document.getElementById('receipt-content').innerHTML = receiptContent;
            document.getElementById('receipt-modal').style.display = 'block';
        }
        
        // طباعة وصل الدفع
        function printReceipt() {
            window.print();
        }
        
        // طباعة وصل محدد
        function printSingleReceipt(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (payment) {
                generateReceipt(paymentId, payment);
            }
        }
        
        // إغلاق نافذة الوصل
        function closeReceiptModal() {
            document.getElementById('receipt-modal').style.display = 'none';
        }
        
        // تنسيق التاريخ بأرقام أجنبية
        function formatDateWithForeignNumbers(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                numberingSystem: 'latn'
            };
            
            let formattedDate = date.toLocaleDateString('ar-EG', options);
            
            // استبدال الأرقام العربية بأجنبية (في حالة عدم دعم numberingSystem)
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            for (let i = 0; i < arabicNumbers.length; i++) {
                formattedDate = formattedDate.replace(new RegExp(arabicNumbers[i], 'g'), i);
            }
            
            return formattedDate;
        }
        
        // وظائف مساعدة
        function getStatusText(status) {
            switch (status) {
                case 'completed': return 'مكتمل';
                case 'refunded': return 'مسترد';
                default: return 'قيد الانتظار';
            }
        }
        
        function getStatusIcon(status) {
            switch (status) {
                case 'completed': return 'check-circle';
                case 'refunded': return 'undo';
                default: return 'clock';
            }
        }
    </script>
</body>
</html>
